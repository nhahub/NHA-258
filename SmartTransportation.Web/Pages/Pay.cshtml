@page
@model SmartTransportation.Web.Pages.Payment.PayModel
@{
    ViewData["Title"] = "Pay Platform Fee";
}

<link rel="stylesheet" href="~/css/payment.css" />

<div class="payment-container">
    <div class="payment-card">
        <h2 class="payment-title">Pay Platform Fee</h2>

        <p class="booking-info">
            Booking ID:
            <strong>@Model.BookingId</strong>
        </p>

        @if (!string.IsNullOrEmpty(Model.ResultMessage))
        {
            <div class="result-message @(Model.ResultStatus == "Succeeded" ? "success" : "error")">
                @Model.ResultMessage
            </div>

            @* Auto redirect on success *@
            if (Model.ResultStatus == "Succeeded" && !string.IsNullOrEmpty(Model.RedirectUrl))
            {
                <script>
                    setTimeout(function () {
                        window.location.href = '@Model.RedirectUrl';
                    }, 5000);
                </script>

                <p class="redirect-text">
                    Redirecting in 5 seconds...
                </p>
            }
        }

        <form id="payment-form" method="post">
            @Html.AntiForgeryToken()

            <input type="hidden" asp-for="BookingId" />
            <input type="hidden" asp-for="PaymentMethodId" />

            <label for="card-element" class="label">Card Details</label>
            <div id="card-element" class="stripe-input"></div>
            <div id="card-errors" class="error-text"></div>

            <button id="submit-button" type="submit" class="pay-btn">Pay Now</button>
        </form>
    </div>
</div>

@section Scripts {
    <script src="https://js.stripe.com/v3"></script>

    <script>
        const stripe = Stripe('@Model.StripePublishableKey');
        const elements = stripe.elements();
        const cardElement = elements.create('card', {
            hidePostalCode: true
        });
        cardElement.mount('#card-element');

        const form = document.getElementById('payment-form');
        const submitButton = document.getElementById('submit-button');
        const errorDiv = document.getElementById('card-errors');

        form.addEventListener('submit', async function (event) {
            event.preventDefault();
            errorDiv.textContent = '';
            submitButton.disabled = true;
            submitButton.textContent = "Processing...";

            const { error, paymentMethod } = await stripe.createPaymentMethod({
                type: 'card',
                card: cardElement
            });

            if (error) {
                errorDiv.textContent = error.message;
                submitButton.disabled = false;
                submitButton.textContent = "Pay Now";
                return;
            }

            document.querySelector('input[name="PaymentMethodId"]').value = paymentMethod.id;
            form.submit();
        });
    </script>
}
