@page
@model SmartTransportation.Web.Pages.Admin.Admin2Model
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@{
    ViewData["Title"] = "Driver Management";
    Layout = "_Layout";
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin_dashboard_css.css" />
}

<div class="admin-container">
    <!-- Admin Header -->
    <div class="admin-header">
        <h1>Driver Management</h1>
        <p>Review and manage drivers and their vehicles</p>
    </div>

    <form method="post">
        <input name="__RequestVerificationToken" type="hidden"
               value='@Antiforgery.GetAndStoreTokens(HttpContext).RequestToken' />
    </form>

    <div class="content-tabs">
        <div class="tab-content">
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>City</th>
                            <th>Rating</th>
                            <th>Status</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Drivers != null && Model.Drivers.Any())
                        {
                            foreach (var driver in Model.Drivers)
                            {
                                <tr id="driver-row-@driver.DriverId">
                                    <td>@driver.Driver.FullName</td>
                                    <td>@driver.Driver.Phone</td>
                                    <td>@driver.Driver.City</td>
                                    <td>
                                        <span class="status-badge status-active">@driver.Driver.DriverRating ⭐</span>
                                    </td>
                                    <td id="driver-verified-@driver.DriverId">
                                        @if (driver.Driver.IsDriverVerified)
                                        {
                                            <span class="status-badge status-active">✔ Verified</span>
                                        }
                                        else
                                        {
                                            <span class="status-badge status-inactive">✖ Not Verified</span>
                                        }
                                    </td>
                                    <td class="text-end">
                                        <div class="action-buttons">
                                            <button type="button" onclick="verifyDriver(@driver.DriverId,true)" class="btn-icon btn-edit">✔</button>
                                            <button type="button" onclick="verifyDriver(@driver.DriverId,false)" class="btn-icon btn-delete">✖</button>
                                            <button type="button" onclick="toggleVehicles(@driver.DriverId)" class="btn-icon btn-edit">🚚</button>
                                        </div>
                                    </td>
                                </tr>

                                <tr id="vehicles-@driver.DriverId">
                                    <td colspan="6">
                                        <div>
                                            <h6>@driver.Driver.FullName's Vehicles</h6>
                                            <div class="table-container">
                                                <table class="data-table">
                                                    <thead>
                                                        <tr>
                                                            <th>Make</th>
                                                            <th>Model</th>
                                                            <th>Year</th>
                                                            <th>Plate</th>
                                                            <th>Verified</th>
                                                            <th class="text-end">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="vehicle-body-@driver.DriverId">
                                                        @if (driver.Vehicles != null && driver.Vehicles.Any())
                                                        {
                                                            foreach (var v in driver.Vehicles)
                                                            {
                                                                var isDriverVerified = driver.Driver.IsDriverVerified;
                                                                <tr>
                                                                    <td>@v.VehicleMake</td>
                                                                    <td>@v.VehicleModel</td>
                                                                    <td>@v.VehicleYear</td>
                                                                    <td>@v.PlateNumber</td>
                                                                    <td id="vehicle-verified-@v.VehicleId">
                                                                        @if (v.IsVerified)
                                                                        {
                                                                            <span class="status-badge status-active">✔</span>
                                                                        }
                                                                        else
                                                                        {
                                                                            <span class="status-badge status-inactive">✖</span>
                                                                        }
                                                                    </td>
                                                                    <td class="text-end">
                                                                        <div class="action-buttons">
                                                                            <button type="button"
                                                                                    onclick="verifyVehicle(@driver.DriverId,@v.VehicleId,true)"
                                                                                    class="btn-icon btn-edit"
                                                                                    @(!isDriverVerified ? "disabled style='opacity:0.5;cursor:not-allowed;'" : "")>
                                                                                ✔
                                                                            </button>
                                                                            <button type="button"
                                                                                    onclick="verifyVehicle(@driver.DriverId,@v.VehicleId,false)"
                                                                                    class="btn-icon btn-delete"
                                                                                    @(!isDriverVerified ? "disabled style='opacity:0.5;cursor:not-allowed;'" : "")>
                                                                                ✖
                                                                            </button>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                            }
                                                        }
                                                        else
                                                        {
                                                            <tr>
                                                                <td colspan="6" style="text-align:center; color: var(--gray-600); padding: 40px 20px;">No vehicles</td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6" style="text-align:center; color: var(--gray-600); padding: 40px 20px;">No drivers found</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function getAntiForgeryToken() {
            return document.querySelector('input[name="__RequestVerificationToken"]').value;
        }

        async function verifyDriver(driverId, isVerified) {
            try {
                const res = await fetch(`?handler=VerifyDriver&driverId=${driverId}&isVerified=${isVerified}`, {
                    method: 'POST',
                    headers: { 'RequestVerificationToken': getAntiForgeryToken() }
                });
                const data = await res.json();
                alert(data.message);

                const verifiedCell = document.getElementById(`driver-verified-${driverId}`);
                verifiedCell.innerHTML = isVerified
                    ? '<span class="status-badge status-active">✔ Verified</span>'
                    : '<span class="status-badge status-inactive">✖ Not Verified</span>';

                const vehicleButtons = document.querySelectorAll(`#vehicle-body-${driverId} button`);
                vehicleButtons.forEach(btn => {
                    btn.disabled = !isVerified;
                    btn.style.opacity = isVerified ? '1' : '0.5';
                    btn.style.cursor = isVerified ? 'pointer' : 'not-allowed';
                    if (!isVerified) btn.title = 'Driver must be verified first';
                    else btn.removeAttribute('title');
                });

                if (!isVerified) {
                    const vehicleCells = document.querySelectorAll(`#vehicle-body-${driverId} td[id^="vehicle-verified-"]`);
                    vehicleCells.forEach(td => td.innerHTML = '<span class="status-badge status-inactive">✖</span>');
                }
            } catch (e) {
                console.error(e);
                alert("An error occurred. Please try again.");
            }
        }

        async function verifyVehicle(driverId, vehicleId, isVerified) {
            const driverVerifiedText = document.getElementById(`driver-verified-${driverId}`).innerText.trim();
            if (!driverVerifiedText.includes("✔") && isVerified) {
                alert("Driver must be verified first before verifying vehicles.");
                return;
            }

            try {
                const res = await fetch(`?handler=VerifyVehicle&driverId=${driverId}&vehicleId=${vehicleId}&isVerified=${isVerified}`, {
                    method: 'POST',
                    headers: { 'RequestVerificationToken': getAntiForgeryToken() }
                });
                const data = await res.json();
                if (data.success) {
                    const cell = document.getElementById(`vehicle-verified-${vehicleId}`);
                    cell.innerHTML = isVerified
                        ? '<span class="status-badge status-active">✔</span>'
                        : '<span class="status-badge status-inactive">✖</span>';
                }
                alert(data.message);
            } catch (e) {
                console.error(e);
                alert("An error occurred. Please try again.");
            }
        }

        function toggleVehicles(driverId) {
            const row = document.getElementById(`vehicles-${driverId}`);
            row.style.display = row.style.display === 'none' || row.style.display === '' ? 'table-row' : 'none';
        }
    </script>
}