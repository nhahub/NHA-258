@page
@model SmartTransportation.Web.Pages.Admin.Admin2Model
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@{
    ViewData["Title"] = "Admin Dashboard";
    Layout = "_Layout";

    // Pagination properties
    int currentPage = 1;
    int routesPerPage = 6;
    int totalRoutes = Model.Routes?.Count ?? 0;
    int totalPages = totalRoutes > 0 ? (int)Math.Ceiling((double)totalRoutes / routesPerPage) : 0;
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin_dashboard_css.css" />
    <style>
        /* ===== TAB SWITCHER ===== */
        .tab-switcher {
            display: flex;
            background: var(--gray-50);
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            border-radius: 6px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--gray-600);
        }

            .tab-btn.active, .tab-btn:hover {
                background: white;
                color: var(--primary-600);
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }

        .tab-content {
            display: none;
        }

            .tab-content.active {
                display: block;
            }

        /* ===== PAGINATION ===== */
        .pagination-section {
            margin-top: 24px;
        }

        .pagination-controls {
            margin-top: 24px;
            display: flex;
            justify-content: center;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .pagination-btn {
            padding: 8px 16px;
            border: 1px solid var(--gray-300);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

            .pagination-btn:hover:not(.disabled) {
                background: var(--gray-50);
                border-color: var(--gray-400);
            }

            .pagination-btn.disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

        .page-numbers {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .page-num {
            padding: 8px 12px;
            border: 1px solid var(--gray-300);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            min-width: 36px;
            text-align: center;
            transition: all 0.2s;
        }

            .page-num:hover:not(.active) {
                background: var(--gray-50);
                border-color: var(--gray-400);
            }

            .page-num.active {
                background: var(--primary-600);
                color: white;
                border-color: var(--primary-600);
            }

        /* ===== ROUTE STYLES ===== */
        .routes-grid {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(auto-fill,minmax(400px,1fr));
        }

        .route-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .route-summary {
            font-weight: 600;
            color: var(--gray-700);
        }

        .form-input {
            padding: 8px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 14px;
        }

        .segment-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

            .segment-row input {
                padding: 6px;
                border-radius: 4px;
                border: 1px solid var(--gray-300);
                min-width: 120px;
            }
    </style>
}

<div class="admin-container">
    <!-- ================= HEADER & TABS ================= -->
    <div class="admin-header">
        <h1>Admin Dashboard</h1>
        <p>Manage drivers, vehicles, and routes efficiently</p>
    </div>

    <div class="tab-switcher">
        <button class="tab-btn active" onclick="switchTab('drivers')">👨‍💼 Driver Management</button>
        <button class="tab-btn" onclick="switchTab('routes')">🗺️ Route Management</button>
    </div>

    <!-- ================= DRIVERS TAB ================= -->
    <div id="drivers-tab" class="tab-content active">
        <input type="hidden" id="antiforgery-token" value="@Antiforgery.GetAndStoreTokens(HttpContext).RequestToken" />

        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>City</th>
                        <th>Rating</th>
                        <th>Status</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Drivers?.Any() == true)
                    {
                        foreach (var driver in Model.Drivers)
                        {
                            <tr id="driver-row-@driver.DriverId">
                                <td>@driver.Driver.FullName</td>
                                <td>@driver.Driver.Phone</td>
                                <td>@driver.Driver.City</td>
                                <td><span class="status-badge status-active">@driver.Driver.DriverRating ⭐</span></td>
                                <td id="driver-verified-@driver.DriverId">
                                    @if (driver.Driver.IsDriverVerified)
                                    {
                                        <span class="status-badge status-active">✔ Verified</span>
                                    }
                                    else
                                    {
                                        <span class="status-badge status-inactive">✖ Not Verified</span>
                                    }
                                </td>
                                <td class="text-end">
                                    <div class="action-buttons">
                                        <button type="button" onclick="verifyDriver(@driver.DriverId,true)" class="btn-icon btn-edit">✔</button>
                                        <button type="button" onclick="verifyDriver(@driver.DriverId,false)" class="btn-icon btn-delete">✖</button>
                                        <button type="button" onclick="toggleVehicles(@driver.DriverId)" class="btn-icon btn-edit">🚚</button>
                                    </div>
                                </td>
                            </tr>

                            <tr id="vehicles-@driver.DriverId" style="display:none;">
                                <td colspan="6">
                                    <div>
                                        <h6>@driver.Driver.FullName's Vehicles</h6>
                                        <div class="table-container">
                                            <table class="data-table">
                                                <thead>
                                                    <tr>
                                                        <th>Make</th>
                                                        <th>Model</th>
                                                        <th>Year</th>
                                                        <th>Plate</th>
                                                        <th>Verified</th>
                                                        <th class="text-end">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="vehicle-body-@driver.DriverId">
                                                    @if (driver.Vehicles?.Any() == true)
                                                    {
                                                        foreach (var v in driver.Vehicles)
                                                        {
                                                            var isDriverVerified = driver.Driver.IsDriverVerified;
                                                            <tr>
                                                                <td>@v.VehicleMake</td>
                                                                <td>@v.VehicleModel</td>
                                                                <td>@v.VehicleYear</td>
                                                                <td>@v.PlateNumber</td>
                                                                <td id="vehicle-verified-@v.VehicleId">
                                                                    @if (v.IsVerified)
                                                                    {
                                                                        <span class="status-badge status-active">✔</span>
                                                                    }
                                                                    else
                                                                    {
                                                                        <span class="status-badge status-inactive">✖</span>
                                                                    }
                                                                </td>
                                                                <td class="text-end">
                                                                    <div class="action-buttons">
                                                                        <button type="button"
                                                                                onclick="verifyVehicle(@driver.DriverId,@v.VehicleId,true)"
                                                                                class="btn-icon btn-edit"
                                                                                @(isDriverVerified ? "" : "disabled style='opacity:0.5;cursor:not-allowed;'")>
                                                                            ✔
                                                                        </button>
                                                                        <button type="button"
                                                                                onclick="verifyVehicle(@driver.DriverId,@v.VehicleId,false)"
                                                                                class="btn-icon btn-delete"
                                                                                @(isDriverVerified ? "" : "disabled style='opacity:0.5;cursor:not-allowed;'")>
                                                                            ✖
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <tr><td colspan="6" style="text-align:center; color: var(--gray-600); padding:40px 20px;">No vehicles</td></tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr><td colspan="6" style="text-align:center; color:var(--gray-600); padding:40px 20px;">No drivers found</td></tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- ================= ROUTES TAB ================= -->
    <div id="routes-tab" class="tab-content">
        @if (TempData["SuccessMessage"] != null)
        {
            <div style="background: var(--success-100); color: var(--success-800); padding:8px 16px; border-radius:6px; font-size:14px; margin-bottom:16px;">
                @TempData["SuccessMessage"]
            </div>
        }
        @if (!ViewData.ModelState.IsValid)
        {
            <div class="error">@Html.ValidationSummary(false)</div>
        }

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <div>
                <h2>Route Management</h2>
                <p>CRUD operations for routes with segments</p>
            </div>
            <button class="btn btn-edit" onclick="toggleRouteForm('create')">+ Add Route</button>
        </div>

        <!-- CREATE FORM -->
        <form method="post" asp-page-handler="AddRoute" id="create-form">
            @Html.AntiForgeryToken()
            <div id="create-route-form" style="display:none; margin-bottom:24px; background:var(--gray-50); padding:20px; border-radius:12px; border:2px solid var(--gray-200);">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px;">
                    <input asp-for="NewRoute.RouteName" placeholder="Route Name *" class="form-input" required />
                    <select asp-for="NewRoute.RouteType" class="form-input" required>
                        <option value="">-- Select Route Type --</option>
                        <option value="Urban">Urban</option>
                        <option value="Agricultural">Agricultural / Rural</option>
                        <option value="Desert">Desert / Remote</option>
                        <option value="Coastal">Coastal</option>
                        <option value="Touristic">Touristic</option>
                    </select>
                    <input asp-for="NewRoute.StartLocation" placeholder="Start Location *" class="form-input" required />
                    <input asp-for="NewRoute.EndLocation" placeholder="End Location *" class="form-input" required />
                    <div style="display:flex; align-items:center; gap:8px;">
                        <label style="margin:0;"><input asp-for="NewRoute.IsCircular" type="checkbox" /> Circular Route</label>
                    </div>
                </div>

                <h4 style="margin-bottom:8px;">Segments</h4>
                <div id="create-segments-container" class="segments-list">
                    <div class="segment-row" data-index="0">
                        <input name="NewRoute.Segments[0].StartPoint" placeholder="Start Point *" required />
                        <input name="NewRoute.Segments[0].EndPoint" placeholder="End Point *" required />
                        <input name="NewRoute.Segments[0].SegmentDistanceKm" placeholder="Distance (km)" type="number" step="0.1" min="0" />
                        <input name="NewRoute.Segments[0].SegmentEstimatedMinutes" placeholder="Est. Minutes" type="number" min="0" />
                        <input name="NewRoute.Segments[0].SegmentOrder" type="hidden" value="1" />
                        <button type="button" onclick="removeSegment(this)" style="background:var(--danger-500); color:white; border:none; padding:6px 8px; border-radius:6px;">✕</button>
                    </div>
                </div>

                <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
                    <button type="button" class="btn btn-add-segment" onclick="addSegment('create')">+ Segment</button>
                    <button type="submit" class="btn btn-edit">Create Route</button>
                    <button type="button" class="btn" onclick="toggleRouteForm('create')" style="background:var(--gray-300);">Cancel</button>
                </div>
            </div>
        </form>

        <!-- EDIT FORM -->
        @if (Model.IsEditing && Model.EditingRouteId.HasValue)
        {
            <form method="post" asp-page-handler="UpdateRoute" id="edit-form">
                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="EditRoute.RouteId" />
                <div id="edit-route-form" style="display:block; margin-bottom:24px; background:var(--gray-50); padding:20px; border-radius:12px; border:2px solid var(--primary-300);">
                    <!-- Edit fields same as create -->
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px;">
                        <input asp-for="EditRoute.RouteName" placeholder="Route Name *" class="form-input" required />
                        <input asp-for="EditRoute.RouteType" placeholder="Route Type" class="form-input" />
                        <input asp-for="EditRoute.StartLocation" placeholder="Start Location *" class="form-input" required />
                        <input asp-for="EditRoute.EndLocation" placeholder="End Location *" class="form-input" required />
                        <div style="display:flex; align-items:center; gap:8px;">
                            <label style="margin:0;"><input asp-for="EditRoute.IsCircular" type="checkbox" /> Circular Route</label>
                        </div>
                    </div>

                    <h4 style="margin-bottom:8px;">Segments</h4>
                    <div id="edit-segments-container" class="segments-list">
                        @if (Model.EditRoute?.Segments?.Any() == true)
                        {
                            for (int i = 0; i < Model.EditRoute.Segments.Count; i++)
                            {
                                <div class="segment-row" data-index="@i">
                                    <input asp-for="EditRoute.Segments[i].StartPoint" placeholder="Start Point *" required />
                                    <input asp-for="EditRoute.Segments[i].EndPoint" placeholder="End Point *" required />
                                    <input asp-for="EditRoute.Segments[i].SegmentDistanceKm" placeholder="Distance (km)" type="number" step="0.1" min="0" />
                                    <input asp-for="EditRoute.Segments[i].SegmentEstimatedMinutes" placeholder="Est. Minutes" type="number" min="0" />
                                    <input asp-for="EditRoute.Segments[i].SegmentOrder" type="hidden" />
                                    <button type="button" onclick="removeSegment(this)" style="background:var(--danger-500); color:white; border:none; padding:6px 8px; border-radius:6px;">✕</button>
                                </div>
                            }
                        }
                    </div>

                    <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
                        <button type="button" class="btn btn-add-segment" onclick="addSegment('edit')">+ Segment</button>
                        <button type="submit" class="btn btn-edit">Update Route</button>
                        <button type="button" class="btn" onclick="cancelEdit()" style="background:var(--gray-300);">Cancel</button>
                    </div>
                </div>
            </form>
        }

        <!-- ================= ROUTES GRID & PAGINATION ================= -->
        <div class="pagination-section">
            <div id="routes-grid" class="routes-grid">
                @if (Model.Routes?.Any() == true)
                {
                    foreach (var route in Model.Routes)
                    {
                        <div class="route-card" data-route-id="@route.RouteId">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px;">
                                <div style="flex:1;">
                                    <div class="route-summary">@route.RouteName <span style="font-size:13px; opacity:0.8;">(@(route.IsCircular ? "🔄 Circular" : "➡️ Linear"))</span></div>
                                    <div style="font-size:13px; color:var(--gray-600);">@route.StartLocation → @route.EndLocation</div>
                                    <div style="font-size:13px; color:var(--gray-600);">
                                        📏 @((route.TotalDistanceKm ?? 0).ToString("F1"))km • ⏱️ @(route.EstimatedTimeMinutes ?? 0)min • 📅 @route.CreatedAt.ToString("MMM dd")
                                    </div>
                                </div>
                                <div class="route-actions">
                                    <button class="btn btn-sm btn-edit" onclick="editRoute(@route.RouteId)" title="Edit">✏️</button>
                                    <button class="btn btn-sm btn-delete" onclick="confirmDelete(@route.RouteId,'@Html.Raw(route.RouteName.Replace("'", "\\'"))')" title="Delete">🗑️</button>
                                    <button class="btn btn-sm" onclick="toggleRouteDetails(@route.RouteId)" title="Details">👁️</button>
                                </div>
                            </div>
                            <div id="route-details-@route.RouteId" style="display:none; margin-top:12px; padding-top:16px; border-top:1px solid var(--gray-200);">
                                @if (route.Segments?.Any() == true)
                                {
                                    <table class="data-table compact">
                                        <thead><tr><th>#</th><th>Start</th><th>End</th><th>Km</th><th>Min</th></tr></thead>
                                        <tbody>
                                            @foreach (var seg in route.Segments.OrderBy(s => s.SegmentOrder))
                                            {
                                                <tr>
                                                    <td>@seg.SegmentOrder</td>
                                                    <td>@seg.StartPoint</td>
                                                    <td>@seg.EndPoint</td>
                                                    <td>@((seg.DistanceKm ?? 0).ToString("F1"))</td>
                                                    <td>@(seg.EstimatedMinutes ?? 0)</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                }
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div style="text-align:center; padding:40px; color:var(--gray-600); grid-column:1/-1;">
                        <div style="font-size:48px; margin-bottom:16px;">🗺️</div>
                        <div>No routes found. Create your first route above!</div>
                    </div>
                }
            </div>

            <!-- ================= PAGINATION BUTTONS ================= -->
            @if (totalRoutes > 0)
            {
                <div class="pagination-controls">
                    <button class="pagination-btn @(currentPage == 1 ? "disabled" : "")" onclick="changePage(@(currentPage - 1))" id="prev-page">← Previous</button>
                    <div class="page-numbers" id="page-numbers">
                        @{
                            var startPage = Math.Max(1, currentPage - 2);
                            var endPage = Math.Min(totalPages, currentPage + 2);
                            if (startPage > 1)
                            {
                                <span class="page-num @(1 == currentPage ? "active" : "")" onclick="changePage(1)">1</span>
                                if (startPage > 2)
                                {

                                    <span>...</span>
                                }
                            }
                            for (int i = startPage; i <= endPage; i++)
                            {
                                <span class="page-num @(i == currentPage ? "active" : "")" onclick="changePage(@i)">@i</span>
                            }
                            if (endPage < totalPages)
                            {
                                if (endPage < totalPages - 1)
                                {

                                    <span>...</span>
                                }
                                <span class="page-num @(totalPages == currentPage ? "active" : "")" onclick="changePage(@totalPages)">@totalPages</span>
                            }
                        }
                    </div>
                    <button class="pagination-btn @(currentPage >= totalPages ? "disabled" : "")" onclick="changePage(@(currentPage + 1))" id="next-page">Next →</button>
                    <span id="page-info" style="color:var(--gray-600); font-size:14px;">Page @currentPage of @totalPages</span>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        window.currentPage = @currentPage;
        window.routesPerPage = @routesPerPage;
        window.totalRoutes = @totalRoutes;
        window.totalPages = @totalPages;
        window.activeTab = 'routes';
    </script>
    <script src="~/js/admin2.js"></script>
}
