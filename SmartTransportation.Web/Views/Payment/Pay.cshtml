@model SmartTransportation.Web.Models.Payment.PaymentStartViewModel

@{
    ViewData["Title"] = "Pay Platform Fee";
}

<h2>Pay Platform Fee</h2>

<p>Booking ID: @Model.BookingId</p>

@if (Model.PlatformFeeAmount.HasValue)
{
    <p>Platform fee: @Model.PlatformFeeAmount @Model.Currency</p>
}

<form id="payment-form" asp-action="Pay" method="post">
    @Html.AntiForgeryToken()

    <input type="hidden" name="BookingId" value="@Model.BookingId" />
    <input type="hidden" id="PaymentMethodId" name="PaymentMethodId" />

    <div id="card-element"><!-- Stripe card element --></div>
    <div id="card-errors" role="alert" style="color:red;"></div>

    <button id="submit-button" type="submit">Pay</button>
</form>

@section Scripts {
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        const stripe = Stripe('@Model.StripePublishableKey');
        const elements = stripe.elements();
        const cardElement = elements.create('card');
        cardElement.mount('#card-element');

        const form = document.getElementById('payment-form');
        const submitButton = document.getElementById('submit-button');
        const errorDiv = document.getElementById('card-errors');

        form.addEventListener('submit', async function (event) {
            event.preventDefault();
            submitButton.disabled = true;
            errorDiv.textContent = '';

            const { error, paymentMethod } = await stripe.createPaymentMethod({
                type: 'card',
                card: cardElement
            });

            if (error) {
                errorDiv.textContent = error.message;
                submitButton.disabled = false;
                return;
            }

            // Put the PaymentMethodId into hidden field and submit the form
            document.getElementById('PaymentMethodId').value = paymentMethod.id;

            // now submit to MVC POST /Payment/Pay
            form.submit();
        });
    </script>
}
